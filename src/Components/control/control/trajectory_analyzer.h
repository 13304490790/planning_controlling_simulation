#ifndef _TRAJECTORY_ANALYZER_H_
#define _TRAJECTORY_ANALYZER_H_

#define FLAGS_query_forward_time_point_only true

#include <vector>

#include "common/math/box2d.h"
#include "common/math/vec2d.h"
#include "common/proto/planning.pb.h"
#include "common/proto/pnc_point.pb.h"
#include "vehicle_state_provider.h"

/**
 * @class TrajectoryAnalyzer
 * @brief process point query and conversion related to trajectory
 */
class TrajectoryAnalyzer {
 public:
  /**
   * @brief constructor
   */
  TrajectoryAnalyzer() = default;

  /**
   * @brief constructor
   * @param planning_published_trajectory trajectory data generated by
   * planning module
   */
  TrajectoryAnalyzer(
      const planning::ADCTrajectory *planning_published_trajectory);

  /**
   * @brief destructor
   */
  ~TrajectoryAnalyzer() = default;

  /**
   * @brief get sequence number of the trajectory
   * @return sequence number.
   */
  unsigned int seq_num() { return seq_num_; }

  /**
   * @brief query a point of trajectory that its absolute time is closest
   * to the give time.
   * @param t absolute time for query
   * @return a point of trajectory
   */
  points::TrajectoryPoint QueryNearestPointByAbsoluteTime(const double t) const;

  /**
   * @brief query a point of trajectory that its relative time is closest
   * to the give time. The time is relative to the first pointof trajectory
   * @param t relative time for query
   * @return a point of trajectory
   */
  points::TrajectoryPoint QueryNearestPointByRelativeTime(const double t) const;

  /**
   * @brief query a point of trajectory that its position is closest
   * to the given position.
   * @param x value of x-coordination in the given position
   * @param y value of y-coordination in the given position
   * @return a point of trajectory
   */
  points::TrajectoryPoint QueryNearestPointByPosition(const double x,
                                                      const double y) const;

  /**
   * @brief query index of a point of trajectory that its position is closest
   * to the given position.
   * @param x value of x-coordination in the given position
   * @param y value of y-coordination in the given position
   * @return index
   */
  size_t QueryNearestIndexByPosition(const double x, const double y) const;

  /**
   * @brief query index of a point of trajectory that its position is a distance
   * from the given position.
   * @param x value of x-coordination in the given position
   * @param y value of y-coordination in the given position
   * @param d value of distance between the project of given position and the
   * target
   * @return index
   */
  size_t QueryIndexByPosition(const double x, const double y,
                              const double d) const;

  /**
   * @brief query a point on trajectory that its position is closest
   * to the given position.
   * @param x value of x-coordination in the given position
   * @param y value of y-coordination in the given position
   * @return a point on trajectory, the point may be a point of trajectory
   * or interpolated by two adjacent points of trajectory
   */
  points::PathPoint QueryMatchedPathPoint(const double x, const double y) const;

  /**
   * @brief convert a position with theta and speed to trajectory frame,
   * - longitudinal and lateral direction to the trajectory
   * @param x x-value of the position
   * @param y y-value of the position
   * @param theta heading angle on the position
   * @param v speed on the position
   * @param matched_point matched point on trajectory for the given position
   * @param ptr_s longitudinal distance
   * @param ptr_s_dot longitudinal speed
   * @param ptr_d lateral distance
   * @param ptr_d_dot lateral speed
   */
  void ToTrajectoryFrame(const double x, const double y, const double theta,
                         const double v, const points::PathPoint &matched_point,
                         double *ptr_s, double *ptr_s_dot, double *ptr_d,
                         double *ptr_d_dot) const;

  /**
   * @brief Transform the current trajectory points to the center of mass(COM)
   * of the vehicle, given the distance from rear wheels to the center of mass.
   * @param rear_to_com_distance Distance from rear wheels to
   *        the vehicle's center of mass.
   */
  void TrajectoryTransformToCOM(const double rear_to_com_distance);

  /**
   * @brief Compute the position of center of mass(COM) of the vehicle,
   *        given the distance from rear wheels to the center of mass.
   * @param rear_to_com_distance Distance from rear wheels to
   *        the vehicle's center of mass.
   * @param path_point PathPoint along the published planning trajectory.
   * @return The position of the vehicle's center of mass.
   */
  Vec2d ComputeCOMPosition(const double rear_to_com_distance,
                           const points::PathPoint &path_point) const;

  /**
   * @brief get all points of the trajectory
   * @return a vector of trajectory points
   */
  const std::vector<points::TrajectoryPoint> &trajectory_points() const;

 private:
  points::PathPoint FindMinDistancePoint(const points::TrajectoryPoint &p0,
                                         const points::TrajectoryPoint &p1,
                                         const double x, const double y) const;

  std::vector<points::TrajectoryPoint> trajectory_points_;

  double header_time_ = 0.0;
  unsigned int seq_num_ = 0;
};

#endif
